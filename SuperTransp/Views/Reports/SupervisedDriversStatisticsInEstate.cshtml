@model List<SuperTransp.Models.PublicTransportGroupViewModel>
@using System.Text.Json
@{
    Layout = null;

    var chartItems = Model.Select((item, index) => new
    {
        ChartId = $"chart{index}",
        StateName = item.StateName,
        TotalSupervisedDrivers = item.TotalSupervisedDrivers,
        TotalWorkingVehicles = item.TotalWorkingVehicles,
        TotalNotWorkingVehicles = item.TotalNotWorkingVehicles,
        TotalWithVehicle = item.TotalWithVehicle,
        TotalWithoutVehicle = item.TotalWithoutVehicle,
        TotalDriverInPerson = item.TotalDriverInPerson,
        TotalDriverNotInPerson = item.TotalDriverNotInPerson
    });
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Estadísticas de vehículos supervisados por estado</title>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="icon" type="image/x-icon" href="~/images/Logo.ico" />
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            background-color: #f2f4f8;
        }

        h2, h3 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .chart-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
        }

        .chart-card {
            background-color: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            padding: 20px;
            width: 320px;
            text-align: center;
            transition: transform 0.2s;
        }

            .chart-card:hover {
                transform: scale(1.03);
            }

        .state-name {
            margin-top: 15px;
            font-weight: 600;
            color: #34495e;
        }

        .responsive-header {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 20px;
            text-align: center;
        }

        .logo-img {
            width: 12vw;
            max-width: 100px;
            height: auto;
        }

        .header-text h2, .header-text h3 {
            color: #2c3e50;
            margin: 0;
        }

        .controls {
            margin-bottom: 10px;
            text-align: left;
            font-size: 14px;
            color: #555;
        }

        .chart-type-selector {
            text-align: center;
            margin-bottom: 20px;
        }

            .chart-type-selector button {
                padding: 8px 16px;
                margin: 0 5px;
                border: 1px solid #ccc;
                border-radius: 5px;
                background-color: #f0f0f0;
                cursor: pointer;
                transition: background-color 0.3s, border-color 0.3s;
            }

                .chart-type-selector button.active {
                    background-color: #3498db;
                    color: white;
                    border-color: #3498db;
                }
        @@media screen and (max-width: 768px) {
            .responsive-header

        {
            flex-direction: column;
            align-items: center;
        }

        .logo-img {
            margin-bottom: 0.5rem;
        }

        }</style>
</head>
<body>
    <div class="responsive-header">
        <img src="~/images/Logo.png" alt="Logo" class="logo-img" />
        <div class="header-text">
            <h2>Estadísticas de vehículos supervisados por estado</h2>
            <h3>
                @{
                    int totalWorking = 0;
                    int totalNotWorking = 0;
                    int totalWithoutVehicle = 0;

                    if (Model != null && Model.Any())
                    {
                        totalWorking = Model.Sum(x => x.TotalWorkingVehicles);
                        totalNotWorking = Model.Sum(x => x.TotalNotWorkingVehicles);
                        totalWithoutVehicle = Model.Sum(x => x.TotalWithoutVehicle);
                    }
                }
                Total global vehículos operativos: @totalWorking.ToString("N0", new System.Globalization.CultureInfo("de-DE"))
                <br />
                Total global vehículos inoperativos: @totalNotWorking.ToString("N0", new System.Globalization.CultureInfo("de-DE"))
                <br />
                Total global socios sin vehículo: @totalWithoutVehicle.ToString("N0", new System.Globalization.CultureInfo("de-DE"))
            </h3>
        </div>
    </div>

    <div class="chart-type-selector">
        <button id="bar-btn" class="active">Barras</button>
        <button id="pie-btn">Torta</button>
        <button id="donut-btn">Dona</button>
    </div>

    <div class="chart-container" id="chartContainer"></div>

    <script>
        const chartItems = @Html.Raw(JsonSerializer.Serialize(chartItems));

        const apexCharts = {};
        const currentTypes = {};

        const COLORS = [
            '#4CAF50', // Supervisados
            '#2196F3', // Operativos
            '#FF9800', // No Operativos
            '#9C27B0', // Con Vehículo
            '#E91E63', // Sin Vehículo
            '#00BCD4', // Presentes
            '#FFC107'  // Ausentes
        ];

        function getCheckboxIds(chartId) {
            return {
                supervised: `supervised-checkbox-${chartId}`,
                working: `working-checkbox-${chartId}`,
                notWorking: `notworking-checkbox-${chartId}`,
                withVehicle: `withvehicle-checkbox-${chartId}`,
                withoutVehicle: `withoutvehicle-checkbox-${chartId}`,
                inPerson: `inperson-checkbox-${chartId}`,
                notInPerson: `notinperson-checkbox-${chartId}`
            };
        }

        function getChartData(item) {
            const seriesData = [];
            const labels = [];
            const colors = [];
            const ids = getCheckboxIds(item.ChartId);

            const picks = [
                { show: document.getElementById(ids.supervised).checked, value: item.TotalSupervisedDrivers, label: 'Supervisados', color: COLORS[0] },
                { show: document.getElementById(ids.working).checked, value: item.TotalWorkingVehicles, label: 'Operativos', color: COLORS[1] },
                { show: document.getElementById(ids.notWorking).checked, value: item.TotalNotWorkingVehicles, label: 'No Operativos', color: COLORS[2] },
                { show: document.getElementById(ids.withVehicle).checked, value: item.TotalWithVehicle, label: 'Con Vehículo', color: COLORS[3] },
                { show: document.getElementById(ids.withoutVehicle).checked, value: item.TotalWithoutVehicle, label: 'Sin Vehículo', color: COLORS[4] },
                { show: document.getElementById(ids.inPerson).checked, value: item.TotalDriverInPerson, label: 'Presentes', color: COLORS[5] },
                { show: document.getElementById(ids.notInPerson).checked, value: item.TotalDriverNotInPerson, label: 'Ausentes', color: COLORS[6] }
            ];

            picks.forEach(p => {
                if (p.show) {
                    seriesData.push(p.value);
                    labels.push(p.label);
                    colors.push(p.color);
                }
            });

            return { seriesData, labels, colors };
        }

        function pieDonutTooltipCustom({ series, seriesIndex, w }) {
            const label = w?.globals?.labels?.[seriesIndex] ?? `Elemento ${seriesIndex + 1}`;
            const val = series?.[seriesIndex] ?? 0;
            const value = Number(val).toLocaleString('de-DE');
            return `<div class="apex-tooltip"><span>${label}: ${value}</span></div>`;
        }

        function getChartOptions(chartType, data, item) {
            const base = {
                chart: { type: chartType, height: 250 },
                legend: { show: false },
                colors: data.colors.length ? data.colors : COLORS,
                responsive: [{ breakpoint: 480, options: { chart: { width: 200 }, legend: { position: 'bottom' } } }]
            };

            if (chartType === 'donut' || chartType === 'pie') {
                const options = {
                    ...base,
                    series: data.seriesData,
                    labels: data.labels,
                    dataLabels: {
                        enabled: true,
                        formatter: function (val, opts) {
                            return opts.w.config.series[opts.seriesIndex]?.toLocaleString('de-DE');
                        }
                    },
                    tooltip: {
                        custom: pieDonutTooltipCustom
                    },
                    plotOptions: {
                        pie: {
                            expandOnClick: chartType === 'pie' ? false : true
                        }
                    }
                };

                if (chartType === 'donut') {
                    options.plotOptions.pie.donut = {
                        labels: {
                            show: true,
                            total: {
                                show: true,
                                label: 'Total Operativos',
                                formatter: function () {
                                    return (item.TotalWorkingVehicles ?? 0).toLocaleString('de-DE');
                                }
                            }
                        }
                    };
                }

                return options;
            }

            if (chartType === 'bar') {
                return {
                    ...base,
                    chart: { ...base.chart, type: 'bar' },
                    series: [{ name: 'Valores', data: data.seriesData }],
                    xaxis: {
                        categories: data.labels,
                        labels: { rotate: -30, trim: true }
                    },
                    plotOptions: {
                        bar: {
                            horizontal: false,
                            columnWidth: '55%',
                            distributed: true,
                            dataLabels: { position: 'top' }
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        formatter: function (val) { return (val ?? 0).toLocaleString('de-DE'); },
                        offsetY: -10,
                        style: { fontSize: '12px', colors: ['#304758'] }
                    },
                    tooltip: {
                        y: { formatter: val => (val ?? 0).toLocaleString('de-DE') }
                    }
                };
            }

            return base;
        }

        function activeChartType() {
            return document.querySelector('.chart-type-selector button.active').id.replace('-btn', '');
        }

        function renderChart(item, chartType) {
            if (apexCharts[item.ChartId]) {
                try { apexCharts[item.ChartId].destroy(); } catch (_) {}
            }
            const chartDiv = document.getElementById(item.ChartId);
            // limpiar contenedor por si queda SVG residual
            chartDiv.innerHTML = '';

            const data = getChartData(item);
            const options = getChartOptions(chartType, data, item);

            const chart = new ApexCharts(chartDiv, options);
            chart.render();
            apexCharts[item.ChartId] = chart;
            currentTypes[item.ChartId] = chartType;
        }

        function updateChart(chartId) {
            const chartType = currentTypes[chartId] || activeChartType();
            const item = chartItems.find(i => i.ChartId === chartId);
            const data = getChartData(item);
            const options = getChartOptions(chartType, data, item);
            // actualizar en caliente dentro del mismo tipo
            apexCharts[chartId].updateOptions(options, true, true);
        }

        function changeAllChartsType(chartType) {
            chartItems.forEach(item => renderChart(item, chartType));
            document.querySelectorAll('.chart-type-selector button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${chartType}-btn`).classList.add('active');
        }

        const container = document.getElementById('chartContainer');

        if (!chartItems || chartItems.length === 0) {
            const card = document.createElement('div');
            card.className = 'chart-card';
            const emptyDiv = document.createElement('div');
            emptyDiv.style.height = '250px';
            emptyDiv.style.display = 'flex';
            emptyDiv.style.alignItems = 'center';
            emptyDiv.style.justifyContent = 'center';
            emptyDiv.style.color = '#888';
            emptyDiv.style.font = '16px Segoe UI';
            emptyDiv.textContent = 'No existen vehículos supervisados';
            card.appendChild(emptyDiv);
            container.appendChild(card);
        } else {
            chartItems.forEach(item => {
                const card = document.createElement('div');
                card.className = 'chart-card';

                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'controls';

                const ids = getCheckboxIds(item.ChartId);

                controlsDiv.innerHTML += `
                    <input type="checkbox" id="${ids.supervised}" checked>
                    <label for="${ids.supervised}">Supervisados</label>
                `;
                controlsDiv.innerHTML += `
                    <input type="checkbox" id="${ids.working}" checked>
                    <label for="${ids.working}">Operativos</label>
                `;
                controlsDiv.innerHTML += `
                    <input type="checkbox" id="${ids.notWorking}" checked>
                    <label for="${ids.notWorking}">No Operativos</label>
                `;
                controlsDiv.innerHTML += `
                    <input type="checkbox" id="${ids.withVehicle}">
                    <label for="${ids.withVehicle}">Con Vehículo</label>
                `;
                controlsDiv.innerHTML += `
                    <input type="checkbox" id="${ids.withoutVehicle}">
                    <label for="${ids.withoutVehicle}">Sin Vehículo</label>
                `;
                controlsDiv.innerHTML += `
                    <input type="checkbox" id="${ids.inPerson}">
                    <label for="${ids.inPerson}">Presentes</label>
                `;
                controlsDiv.innerHTML += `
                    <input type="checkbox" id="${ids.notInPerson}">
                    <label for="${ids.notInPerson}">Ausentes</label>
                `;

                const chartDiv = document.createElement('div');
                chartDiv.id = item.ChartId;

                const label = document.createElement('div');
                label.className = 'state-name';
                label.innerText = item.StateName;

                card.appendChild(controlsDiv);
                card.appendChild(chartDiv);
                card.appendChild(label);
                container.appendChild(card);

                renderChart(item, 'bar');

                Object.values(ids).forEach(cid => {
                    document.getElementById(cid).addEventListener('change', () => updateChart(item.ChartId));
                });
            });
        }

        document.getElementById('donut-btn').addEventListener('click', () => changeAllChartsType('donut'));
        document.getElementById('pie-btn').addEventListener('click', () => changeAllChartsType('pie'));
        document.getElementById('bar-btn').addEventListener('click', () => changeAllChartsType('bar'));
    </script>
</body>
</html>